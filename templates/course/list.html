{% extends 'base.html' %}
{% load fontawesome_5 %}
{% load call_method %}
{% load rules %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Courses</li>
{% endblock %}

{% block content %}
{% has_perm 'course.create' request.user as can_create_course %}

{% if can_create_course %}
<div class="mb-4">
    <a href="{% url 'courses:create' %}" class="btn btn-primary">{% fa5_icon 'plus-circle' 'fas' %} New Course</a>
</div>
{% endif %}

<div class="table-responsive">
    <table class="table">
        <thead class="thead-inverse">
            <tr>
                <th>Course</th>
                <th>Group</th>
                <th>Tasks</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for course in courses %}
                {% has_perm 'course.join' request.user course as can_join_course %}
                {% has_perm 'course.update' request.user course as can_update_course %}
                {% has_perm 'course.delete' request.user course as can_delete_course %}
                {% has_perm 'course.detail' request.user course as can_detail_course %}
                <tr>
                    <td>
                        {% if can_detail_course %}
                            <a href="{% url 'courses:tasks:index' course.pk %}">{{ course.code }}</a>
                        {% else %}
                            <a href="{% url 'courses:join' course.pk %}">{{ course.code }}</a>
                        {% endif %}
                        <small class="text-muted d-block">{{ course.academic_year }} - Semester {{ course.semester }}</small>
                    </td>
                    <td class="align-middle">
                        {% call_method course "group" request.user as course_group %}
                        {{ course_group }}
                    </td>
                    <td class="align-middle">{{ course.tasks.count }}</td>
                    <td class="align-middle">
                        <div class="float-right">
                            {% if can_update_course %}
                                <a href="{% url 'courses:edit' course.pk %}" class="btn btn-outline-primary">{% fa5_icon 'edit' 'fas' %}</a>
                            {% endif %}
                            {% if can_delete_course %}
                                <form action="{% url 'courses:delete' course.pk %}" method="post" id="delete-{{ course.pk }}" style="display:none;">{% csrf_token %}</form>
                                <button form="delete-{{ course.pk }}" onclick="return confirm('Are you sure you want to delete this item?');" class="btn btn-outline-danger">{% fa5_icon 'trash-alt' 'fas' %}</button>
                            {% endif %}
                            {% if can_join_course %}
                                <a href="{% url 'courses:join' course.pk %}" class="btn btn-outline-primary">{% fa5_icon 'sign-in-alt' 'fas' %}</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
